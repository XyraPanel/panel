<script setup lang="ts">
import type { TableColumn, CommandPaletteItem  } from '@nuxt/ui'
import type { AdminUserResponse, UsersResponse } from '#shared/types/api'

const { t } = useI18n()

definePageMeta({
  auth: true,
  layout: 'admin',
})
const toast = useToast()
const router = useRouter()
const route = useRoute()

const page = ref(Number.parseInt(route.query.page as string ?? '1', 10) || 1)
const itemsPerPage = ref(50)
const showSearchModal = ref(false)

const {
  data: usersData,
  pending: loading,
  error,
  refresh: refreshUsers,
} = await useAsyncData<UsersResponse>(
  'admin-users',
  () => $fetch('/api/admin/users', {
    query: {
      page: page.value,
      limit: itemsPerPage.value,
    },
  }),
  {
    default: () => ({ data: [], pagination: undefined }),
    watch: [page, itemsPerPage],
  },
)

const users = computed(() => usersData.value?.data ?? [])
const pagination = computed(() => (usersData.value as { pagination?: { page: number; perPage: number; total: number; totalPages: number } })?.pagination)

watch(() => route.query.page, (newPage) => {
  const pageNum = Number.parseInt(newPage as string ?? '1', 10)
  if (!Number.isNaN(pageNum) && pageNum > 0) {
    page.value = pageNum
  }
})

function handlePageChange(newPage: number) {
  page.value = newPage
  router.replace({
    query: { ...route.query, page: newPage },
  })
}

const {
  data: allUsersData,
  execute: executeAllUsersFetch,
} = await useFetch<UsersResponse>('/api/admin/users', {
  key: 'admin-users-all',
  query: { limit: 1000, page: 1 },
  default: () => ({ data: [] }),
  lazy: true,
})

const allUsers = computed(() => allUsersData.value?.data ?? [])

const commandPaletteGroups = computed(() => [{
  id: 'users',
  label: t('admin.users.title'),
  items: allUsers.value.map((user): CommandPaletteItem => {
    const displayName = user.username || user.email
    const fullName = user.name || undefined
    return {
      id: user.id,
      label: displayName,
      suffix: user.email !== displayName ? user.email : undefined,
      prefix: fullName,
      chip: user.role === 'admin' ? { color: 'primary' as const, text: t('admin.users.admin') } : undefined,
      description: fullName ? `${t('admin.users.name')}: ${fullName}` : undefined,
      to: `/admin/users/${user.id}`,
      onSelect: (e) => {
        e.preventDefault()
        router.push(`/admin/users/${user.id}`)
        showSearchModal.value = false
      },
    }
  }),
}])

async function openSearchModal() {
  showSearchModal.value = true
  await executeAllUsersFetch()
}

const columns = computed<TableColumn<AdminUserResponse>[]>(() => [
  { accessorKey: 'username', header: t('admin.users.user') },
  { accessorKey: 'email', header: t('admin.users.email') },
  { accessorKey: 'twoFactorEnabled', header: t('admin.users.twoFactor') },
  { accessorKey: 'serversOwned', header: t('admin.users.servers') },
  { accessorKey: 'role', header: t('admin.users.role') },
  { accessorKey: 'createdAt', header: t('admin.users.created') },
  { id: 'actions', header: t('admin.users.actions') },
])

function getUserAvatar(user: AdminUserResponse) {
  const name = user.name || user.username || user.email
  if (!name) return undefined
  return {
    alt: name,
    text: name.slice(0, 2).toUpperCase(),
  }
}

const errorMessage = computed(() => {
  const err = error.value
  if (!err) {
    return null
  }

  if (typeof err === 'string') {
    return err
  }

  if (err instanceof Error) {
    return err.message
  }

  const message = (err as { data?: { message?: string } }).data?.message
  return message ?? t('admin.users.failedToLoadUsers')
})

const showUserModal = ref(false)
const editingUser = ref<AdminUserResponse | null>(null)
const isSubmitting = ref(false)

const userForm = ref({
  username: '',
  email: '',
  password: '',
  name: '',
  role: 'user' as 'user' | 'admin',
})

function resetForm() {
  userForm.value = {
    username: '',
    email: '',
    password: '',
    name: '',
    role: 'user',
  }
  editingUser.value = null
}

function openCreateModal() {
  resetForm()
  showUserModal.value = true
}

function openEditModal(user: AdminUserResponse) {
  editingUser.value = user
  userForm.value = {
    username: user.username,
    email: user.email,
    password: '',
    name: user.name || '',
    role: user.role as 'user' | 'admin',
  }
  showUserModal.value = true
}

async function handleSubmit() {
  if (!userForm.value.username || !userForm.value.email) {
    toast.add({ title: t('validation.required'), description: t('validation.required'), color: 'error' })
    return
  }

  if (!editingUser.value && !userForm.value.password) {
    toast.add({ title: t('validation.required'), description: t('validation.required'), color: 'error' })
    return
  }

  isSubmitting.value = true

  try {
    if (editingUser.value) {
      await $fetch(`/api/admin/users/${editingUser.value.id}`, {
        method: 'patch',
        body: userForm.value,
      })
      toast.add({ title: t('common.success'), description: t('common.success'), color: 'success' })
    }
    else {
      await $fetch('/api/admin/users', {
        method: 'POST',
        body: userForm.value,
      })
      toast.add({ title: t('common.success'), description: t('common.success'), color: 'success' })
    }

    showUserModal.value = false
    resetForm()
    await refreshUsers()
  } catch (err) {
    toast.add({
      title: t('common.error'),
      description: err instanceof Error ? err.message : t('common.error'),
      color: 'error',
    })
  } finally {
    isSubmitting.value = false
  }
}

async function handleDelete(user: AdminUserResponse) {
  if (!confirm(t('common.delete'))) {
    return
  }

  try {
    await $fetch(`/api/admin/users/${user.id}`, {
      method: 'DELETE',
    })
    toast.add({ title: t('common.success'), description: t('common.success'), color: 'success' })
    await refreshUsers()
  } catch (err) {
    toast.add({
      title: t('common.error'),
      description: err instanceof Error ? err.message : t('common.error'),
      color: 'error',
    })
  }
}

function formatDate(value: string) {
  return new Date(value).toLocaleString()
}
</script>

<template>
  <UPage>
    <UPageBody>
      <UContainer>
        <section class="space-y-6">
          <UCard :ui="{ body: 'space-y-3' }">
            <template #header>
              <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold">{{ t('admin.users.title') }}</h2>
                <div class="flex items-center gap-2">
                  <UButton
                    icon="i-lucide-search"
                    color="neutral"
                    variant="subtle"
                    @click="openSearchModal"
                  >
                    {{ t('common.search') }}
                  </UButton>
                  <UButton icon="i-lucide-user-plus" color="primary" variant="subtle" @click="openCreateModal">
                    {{ t('admin.users.title') }}
                  </UButton>
                </div>
              </div>
            </template>

            <div class="space-y-3">
              <UAlert
                v-if="errorMessage"
                color="error"
                variant="soft"
                icon="i-lucide-alert-triangle"
                :description="errorMessage"
                :title="t('admin.users.failedToLoadUsers')"
              />

              <UTable
                :data="users"
                :columns="columns"
                :loading="loading"
                sticky
                class="w-full"
              >
                <template #loading>
                  <div class="space-y-2 p-4">
                    <USkeleton v-for="i in 4" :key="`row-skeleton-${i}`" class="h-10 w-full" />
                  </div>
                </template>

                <template #empty>
                  <div class="px-4 py-6 text-center text-sm text-muted-foreground">
                    {{ t('admin.users.noUsers') }}
                  </div>
                </template>

                <template #username-cell="{ row }">
                  <div class="flex items-center gap-2">
                    <UAvatar
                      v-bind="getUserAvatar(row.original)"
                      size="xs"
                    />
                    <div class="flex flex-col">
                      <div class="flex items-center gap-1">
                        <NuxtLink :to="`/admin/users/${row.original.id}`" class="font-semibold hover:text-primary">
                          {{ row.original.username }}
                        </NuxtLink>
                        <UIcon
                          v-if="row.original.rootAdmin"
                          name="i-lucide-star"
                          class="h-4 w-4 text-warning"
                        />
                      </div>
                      <p v-if="row.original.name" class="text-xs text-muted-foreground">{{ row.original.name }}</p>
                    </div>
                  </div>
                </template>

                <template #email-cell="{ row }">
                  <span class="text-xs text-muted-foreground">{{ row.original.email }}</span>
                </template>

                <template #twoFactorEnabled-cell="{ row }">
                  <UIcon
                    :name="row.original.twoFactorEnabled ? 'i-lucide-lock' : 'i-lucide-unlock'"
                    :class="row.original.twoFactorEnabled ? 'text-success' : 'text-muted-foreground'"
                    class="h-4 w-4"
                  />
                </template>

                <template #serversOwned-cell="{ row }">
                  <div class="flex items-center gap-2 text-sm">
                    <span>{{ row.original.serversOwned ?? 0 }}</span>
                    <span class="text-muted-foreground">/</span>
                    <span class="text-muted-foreground">{{ row.original.serversAccess ?? 0 }}</span>
                  </div>
                </template>

                <template #role-cell="{ row }">
                  <UBadge :color="row.original.role === 'admin' ? 'error' : 'neutral'" size="sm" variant="subtle">
                    {{ row.original.role === 'admin' ? t('admin.users.admin') : t('admin.users.userRole') }}
                  </UBadge>
                </template>

                <template #createdAt-cell="{ row }">
                  <span class="text-xs text-muted-foreground">{{ formatDate(row.original.createdAt) }}</span>
                </template>

                <template #actions-header>
                  <span class="sr-only">{{ t('admin.users.actions') }}</span>
                </template>

                <template #actions-cell="{ row }">
                  <div class="flex gap-1 justify-end">
                    <UButton icon="i-lucide-user-circle" size="xs" variant="ghost" :to="`/admin/users/${row.original.id}`" />
                    <UButton icon="i-lucide-pencil" size="xs" variant="ghost" @click="openEditModal(row.original)" />
                    <UButton
                      icon="i-lucide-trash"
                      size="xs"
                      variant="ghost"
                      color="error"
                      @click="handleDelete(row.original)"
                    />
                  </div>
                </template>
              </UTable>

              <div v-if="pagination" class="flex items-center justify-between border-t border-default pt-4">
                <div class="text-sm text-muted-foreground">
                  {{ t('admin.users.title') }}
                </div>
                <UPagination
                  v-model:page="page"
                  :total="pagination.total"
                  :items-per-page="pagination.perPage"
                  size="sm"
                  @update:page="handlePageChange"
                />
              </div>
            </div>
          </UCard>
        </section>
      </UContainer>
    </UPageBody>

    <UModal v-model:open="showUserModal" :title="editingUser ? t('common.edit') : t('common.create')"
      :description="editingUser ? t('common.update') : t('common.create')">
      <template #body>
        <form class="space-y-4" @submit.prevent="handleSubmit">
          <UFormField :label="t('auth.username')" name="username" required>
            <UInput v-model="userForm.username" :placeholder="t('auth.username')" required :disabled="isSubmitting"
              class="w-full" />
          </UFormField>

          <UFormField :label="t('auth.email')" name="email" required>
            <UInput v-model="userForm.email" type="email" :placeholder="t('auth.email')" required
              :disabled="isSubmitting" class="w-full" />
          </UFormField>

          <UFormField :label="t('common.name')" name="name">
            <UInput v-model="userForm.name" :placeholder="t('common.name')" :disabled="isSubmitting" class="w-full" />
          </UFormField>

          <UFormField :label="t('auth.password')" name="password" :required="!editingUser">
            <UInput v-model="userForm.password" type="password"
              :placeholder="editingUser ? t('auth.password') : t('auth.password')" :required="!editingUser"
              :disabled="isSubmitting" class="w-full" />
            <template v-if="editingUser" #help>
              {{ t('admin.users.passwordLeaveBlank') }}
            </template>
          </UFormField>

          <UFormField :label="t('admin.users.role')" name="role" required>
            <USelect v-model="userForm.role" :options="[
              { label: t('admin.users.userRole'), value: 'user' },
              { label: t('admin.users.admin'), value: 'admin' },
            ]" :disabled="isSubmitting" class="w-full" />
          </UFormField>
        </form>
      </template>

      <template #footer>
        <div class="flex justify-end gap-2">
          <UButton variant="ghost" color="error" :disabled="isSubmitting" @click="showUserModal = false">
            {{ t('common.cancel') }}
          </UButton>
          <UButton color="primary" variant="subtle" :loading="isSubmitting" @click="handleSubmit">
            {{ editingUser ? t('common.update') : t('common.create') }}
          </UButton>
        </div>
      </template>
    </UModal>

    <UModal v-model:open="showSearchModal" :title="t('admin.users.searchUsers')" :description="t('admin.users.searchUsers')">
      <template #content>
        <UCommandPalette
          :groups="commandPaletteGroups"
          :placeholder="t('admin.users.searchUsers')"
          class="h-96"
          close
          :fuse="{
            fuseOptions: {
              ignoreLocation: true,
              threshold: 0.3,
              keys: ['label', 'suffix', 'prefix', 'description'],
            },
            resultLimit: 50,
            matchAllWhenSearchEmpty: true,
          }"
          @update:open="showSearchModal = $event"
        />
      </template>
    </UModal>
  </UPage>
</template>
