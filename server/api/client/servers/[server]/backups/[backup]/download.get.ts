import { getServerWithAccess } from '#server/utils/server-helpers'
import { useDrizzle, tables, eq } from '#server/utils/drizzle'
import { requireServerPermission } from '#server/utils/permission-middleware'
import { decryptToken } from '#server/utils/wings/encryption'
import { generateBackupDownloadToken } from '../../../../../../../server/utils/wings-tokens'
import { requireAccountUser } from '#server/utils/security'

export default defineEventHandler(async (event) => {
  const accountContext = await requireAccountUser(event)
  const serverId = getRouterParam(event, 'server')
  const backupUuid = getRouterParam(event, 'backup')

  if (!serverId || !backupUuid) {
    throw createError({
      statusCode: 400,
      message: 'Server and backup identifiers are required',
    })
  }

  const { server } = await getServerWithAccess(serverId, accountContext.session)

  await requireServerPermission(event, {
    serverId: server.id,
    requiredPermissions: ['server.backup.download'],
  })

  const db = useDrizzle()
  const backup = db.select()
    .from(tables.serverBackups)
    .where(eq(tables.serverBackups.uuid, backupUuid))
    .limit(1)
    .all()[0]

  if (!backup || backup.serverId !== server.id) {
    throw createError({
      statusCode: 404,
      message: 'Backup not found',
    })
  }

  if (!server.nodeId) {
    throw createError({
      statusCode: 500,
      message: 'Server is not assigned to a Wings node',
    })
  }

  const node = db.select()
    .from(tables.wingsNodes)
    .where(eq(tables.wingsNodes.id, server.nodeId))
    .limit(1)
    .get()
  
  if (!node) {
    throw createError({
      statusCode: 500,
      message: 'Wings node not found',
    })
  }
  
  const tokenSecret = decryptToken(node.tokenSecret)
  
  if (!server.uuid) {
    throw createError({
      statusCode: 500,
      message: 'Server UUID is missing',
    })
  }
  
  const downloadToken = await generateBackupDownloadToken({
    serverUuid: server.uuid,
    backupUuid,
  }, tokenSecret)
  
  const downloadUrl = `${node.scheme}://${node.fqdn}:${node.daemonListen}/download/backup?token=${downloadToken}`
  
  return {
    attributes: {
      url: downloadUrl,
    },
  }
})
